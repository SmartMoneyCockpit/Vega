name: Precheck
description: Fast guardrail for required secrets/flags. Skips instead of failing.
runs:
  using: "composite"
  steps:
    - shell: bash
      id: p
      # ⬇️ Map GitHub contexts -> environment variables seen by the script
      env:
        # GitHub provides this automatically; expose as env so `need GITHUB_TOKEN` works
        GITHUB_TOKEN: ${{ github.token }}

        # Your repo secrets (add/remove as needed)
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        TV_COOKIES: ${{ secrets.TV_COOKIES }}
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}

        # Repo variable toggle (master on/off switch)
        VEGA_ACTIONS_ENABLED: ${{ vars.VEGA_ACTIONS_ENABLED }}
      run: |
        missing=()
        need() { test -n "${!1}" || missing+=("$1"); }

        # ✅ Keep only what you actually use. Remove any you don't need.
        need GITHUB_TOKEN
        need RENDER_API_KEY
        need TV_COOKIES
        need SENDGRID_API_KEY

        # Default to true if variable not set
        : "${VEGA_ACTIONS_ENABLED:=true}"

        if [ "${#missing[@]}" -gt 0 ]; then
          echo "::notice title=Precheck::Missing secrets -> ${missing[*]}"
          echo "ok=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ "$VEGA_ACTIONS_ENABLED" != "true" ]; then
          echo "::notice title=Precheck::VEGA_ACTIONS_ENABLED=false (skipping)"
          echo "ok=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "ok=true" >> "$GITHUB_OUTPUT"
