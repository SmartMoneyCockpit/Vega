  precheck:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.p.outputs.ok }}
      window_ok: ${{ steps.timegate.outputs.window_ok }}
      run_morning_report: ${{ steps.tog.outputs.run_morning_report }}
      run_color_guard: ${{ steps.tog.outputs.run_color_guard }}
      run_econ_calendar: ${{ steps.tog.outputs.run_econ_calendar }}
      run_uptime_ping: ${{ steps.tog.outputs.run_uptime_ping }}
    steps:
      - uses: actions/checkout@v4

      - id: p
        uses: ./.github/actions/precheck
        with:
          vega_actions_enabled: ${{ vars.VEGA_ACTIONS_ENABLED }}

      - id: timegate
        shell: bash
        env:
          TZ: America/Los_Angeles
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Bypass the time window for manual or push runs
          if [ "${EVENT_NAME}" = "workflow_dispatch" ] || [ "${EVENT_NAME}" = "push" ]; then
            echo "window_ok=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=Time gate::Bypassed for ${EVENT_NAME}."
            exit 0
          fi

          # Enforce the time window only for scheduled runs
          now="$(date +'%H:%M')"
          if [ "$now" = "07:30" ] || [ "$now" = "08:30" ]; then
            echo "window_ok=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=Time gate::Proceeding at local time $now"
          else
            echo "window_ok=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=Time gate::Local time $now not in [07:30, 08:30]; skipping."
          fi

      - id: tog
        run: |
          echo "run_morning_report=true" >> "$GITHUB_OUTPUT"
          echo "run_color_guard=true" >> "$GITHUB_OUTPUT"
          echo "run_econ_calendar=true" >> "$GITHUB_OUTPUT"
          echo "run_uptime_ping=true" >> "$GITHUB_OUTPUT"
