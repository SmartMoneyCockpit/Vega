name: alerts-worker
on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 14-22 * * 1-5'   # every 30m during US market hours UTC (adjust as needed)

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Install deps
        run: |
          pip install --upgrade pip
          if [ -f requirements-actions.txt ]; then pip install -r requirements-actions.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Validate required secrets
        run: |
          MISSING=0
          require () { test -z "$1" && echo "❌ Missing: $2" && MISSING=1; }
          require "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" GOOGLE_APPLICATION_CREDENTIALS
          # Add any others you truly need for this worker:
          # require "${{ secrets.SENDGRID_API_KEY }}" SENDGRID_API_KEY
          if [ $MISSING -eq 1 ]; then exit 1; fi

      - name: Mount google creds
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' > $GITHUB_WORKSPACE/gcp_service_account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GITHUB_WORKSPACE/gcp_service_account.json" >> $GITHUB_ENV

      - name: Run alerts worker
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          # SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          # Add your envs as needed...
        run: |
          set -e
          if [ -f alerts_worker.py ]; then
            python alerts_worker.py
          elif [ -f workers/alerts_worker.py ]; then
            python workers/alerts_worker.py
          else
            echo "❌ Could not find alerts_worker.py"; exit 1
          fi
