name: Update Watchlist (Bulk)
true:
  push:
    branches:
    - main
  workflow_dispatch:
    inputs:
      region:
        description: Target region (NA or APAC)
        default: NA
        required: false
      sheet_tab:
        description: Sheet tab to update (e.g., NA_Watch / APAC_Watch)
        default: NA_Watch
        required: false
jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.p.outputs.ok }}
    steps:
    - uses: actions/checkout@v4
    - id: p
      uses: ./.github/actions/precheck
  update_watchlist:
    runs-on: ubuntu-latest
    concurrency:
      group: update-watchlist-bulk
      cancel-in-progress: false
    env:
      VEGA_CONFIG_DIR: config
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}
      SMTP_TO: ${{ secrets.SMTP_TO }}
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: pip install -r requirements-actions.txt
    - name: Run bulk watchlist updater
      run: "python scripts/update_watchlist_bulk.py \\\n  --region \"${{ github.event.inputs.region\
        \ || 'NA' }}\" \\\n  --sheet-tab \"${{ github.event.inputs.sheet_tab || 'NA_Watch'\
        \ }}\"\n"
    needs: precheck
    if: ${{ needs.precheck.outputs.ok == 'true' && github.ref == 'refs/heads/main'
      }}
