name: Cockpit Uptime Ping
on:
  schedule: [{ cron: "*/30 13-23 * * 1-5" }]  # every 30m, 06:00â€“16:59 Phoenix
  workflow_dispatch:
jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Curl app
        id: c
        run: |
          URL="${{ vars.COCKPIT_URL }}"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          echo "code=$code" >> $GITHUB_OUTPUT
          mkdir -p snapshots
          echo "{\"url\":\"$URL\",\"http_code\":\"$code\",\"ts\":\"$(date -u +%FT%TZ)\"}" > snapshots/uptime.json
      - uses: actions/upload-artifact@v4
        with: { name: uptime, path: snapshots/uptime.json, retention-days: 3 }
      - name: Open issue if down
        if: steps.c.outputs.code != '200' && steps.c.outputs.code != '302'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title: `Cockpit DOWN (HTTP ${process.env.CODE})`,
              body: `Health check failed at ${new Date().toISOString()}.`,
              labels: ['ops','incident']
            })
        env: { CODE: ${{ steps.c.outputs.code }} }
