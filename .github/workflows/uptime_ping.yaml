name: Cockpit Uptime Ping

on:
  schedule:
    - cron: '5,35 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve cockpit URL
        id: resolve
        run: |
          URL=""
          if [ -n "${{ secrets.VEGA_COCKPIT_URL }}" ]; then
            URL="${{ secrets.VEGA_COCKPIT_URL }}"
          elif [ -n "${{ vars.VEGA_COCKPIT_URL }}" ]; then
            URL="${{ vars.VEGA_COCKPIT_URL }}"
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          if [ -z "$URL" ]; then
            echo "No URL configured."
          fi

      - name: Curl app
        id: ping
        if: ${{ steps.resolve.outputs.url != '' }}
        env:
          URL: ${{ steps.resolve.outputs.url }}
        run: |
          STATUS="$(curl -s -o /dev/null -w '%{http_code}' "$URL")"
          echo "code=$STATUS" >> "$GITHUB_OUTPUT"
          echo "HTTP status: $STATUS"

      - name: Save snapshot json
        if: ${{ steps.resolve.outputs.url != '' }}
        run: |
          mkdir -p snapshot
          printf '{ "code": "%s", "date": "%s", "url": "%s" }\n' \
            "${{ steps.ping.outputs.code }}" "$(date -u +%FT%TZ)" "${{ steps.resolve.outputs.url }}" \
            > snapshot/uptime.json

      - name: Upload snapshot
        if: ${{ steps.resolve.outputs.url != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: uptime.json
          path: snapshot/uptime.json
          retention-days: 7

      - name: Open incident issue if not 200
        if: ${{ steps.resolve.outputs.url != '' && steps.ping.outputs.code != '200' }}
        uses: actions/github-script@v7
        with:
          script: |
            const code = '${{ steps.ping.outputs.code }}';
            const url  = '${{ steps.resolve.outputs.url }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Cockpit down (${code})`,
              body: `Uptime check failed at ${new Date().toISOString()} UTC\nURL: ${url}\nStatus: ${code}`,
              labels: ['ops','incident']
            });

      - name: Skip note (no URL configured)
        if: ${{ steps.resolve.outputs.url == '' }}
        run: echo "Skipped ping: configure VEGA_COCKPIT_URL as a secret or variable."
