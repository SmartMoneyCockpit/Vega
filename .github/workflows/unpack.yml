name: Unpack uploaded ZIP into repo

on:
  workflow_dispatch:

  push:
    branches: [ upgrade/render-import ]
    paths:
      - '*.zip'

permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip
      - name: Unzip newest archive into repo root
        shell: bash
        run: |
          set -euo pipefail
          zipfile=$(ls -1t *.zip | head -n1)
          echo "ZIP: $zipfile"
          tmpdir=$(mktemp -d)
          unzip -q "$zipfile" -d "$tmpdir"
          shopt -s dotglob
          # If the zip has a single top-level folder, move its contents only
          top_dirs=$(find "$tmpdir" -mindepth 1 -maxdepth 1 -type d | wc -l)
          top_files=$(find "$tmpdir" -maxdepth 1 -type f | wc -l)
          if [ "$top_dirs" -eq 1 ] && [ "$top_files" -eq 0 ]; then
            inner=$(find "$tmpdir" -mindepth 1 -maxdepth 1 -type d)
            mv "$inner"/* .
          else
            mv "$tmpdir"/* .
          fi
          rm -rf "$tmpdir"
          rm -f "$zipfile"
      - name: Commit unpacked files
        uses: EndBug/add-and-commit@v9
        with:
          message: "Unpack uploaded ZIP into repo"
          add: "."
          push: true
