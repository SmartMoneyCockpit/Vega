name: Unpack uploaded ZIP into repo
true:
  workflow_dispatch: null
  push:
    branches:
    - upgrade/render-import
    paths:
    - '*.zip'
permissions:
  contents: write
jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.p.outputs.ok }}
    steps:
    - uses: actions/checkout@v4
    - id: p
      uses: ./.github/actions/precheck
  unpack:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Install unzip
      run: sudo apt-get update && sudo apt-get install -y unzip
    - name: Unzip newest archive into repo root
      shell: bash
      run: "set -euo pipefail\nzipfile=$(ls -1t *.zip | head -n1)\necho \"ZIP: $zipfile\"\
        \ntmpdir=$(mktemp -d)\nunzip -q \"$zipfile\" -d \"$tmpdir\"\nshopt -s dotglob\n\
        # If the zip has a single top-level folder, move its contents only\ntop_dirs=$(find\
        \ \"$tmpdir\" -mindepth 1 -maxdepth 1 -type d | wc -l)\ntop_files=$(find \"\
        $tmpdir\" -maxdepth 1 -type f | wc -l)\nif [ \"$top_dirs\" -eq 1 ] && [ \"\
        $top_files\" -eq 0 ]; then\n  inner=$(find \"$tmpdir\" -mindepth 1 -maxdepth\
        \ 1 -type d)\n  mv \"$inner\"/* .\nelse\n  mv \"$tmpdir\"/* .\nfi\nrm -rf\
        \ \"$tmpdir\"\nrm -f \"$zipfile\"\n"
    - name: Commit unpacked files
      uses: EndBug/add-and-commit@v9
      with:
        message: Unpack uploaded ZIP into repo
        add: .
        push: true
    needs: precheck
    if: ${{ needs.precheck.outputs.ok == 'true' && github.ref == 'refs/heads/main'
      }}
