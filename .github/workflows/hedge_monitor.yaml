name: Hedge Monitor (15m)
true:
  push:
    branches:
    - main
  schedule:
  - cron: '*/15 13-20 * * 1-5'
  workflow_dispatch: null
jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.p.outputs.ok }}
    steps:
    - uses: actions/checkout@v4
    - id: p
      uses: ./.github/actions/precheck
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install Python deps
      run: 'python -m pip install --upgrade pip

        pip install pyyaml==6.0.1

        '
    - name: Build signal
      run: "python - << 'PY'\nimport json, datetime as dt\nfrom pathlib import Path\n\
        import yaml\n\ncfg_path = Path(\"config/vega_rules.yaml\")\nif not cfg_path.exists():\n\
        \    raise SystemExit(f\"ERROR: missing {cfg_path}\")\n\ncfg = yaml.safe_load(cfg_path.read_text())\n\
        \n# Placeholder signal evaluation \u2014 wire your data later\nsignal = {\n\
        \  \"trigger_primary_ready\": False,\n  \"conditions\": {\n    \"vix_gt\"\
        : cfg[\"hedge_rules\"][\"trigger_primary\"][\"vix_gt\"],\n    \"spy_below_vwap\"\
        : cfg[\"hedge_rules\"][\"trigger_primary\"][\"spy_below_vwap\"],\n    \"breadth_below\"\
        : cfg[\"hedge_rules\"][\"trigger_primary\"][\"breadth_below\"]\n  },\n  \"\
        ts_utc\": dt.datetime.utcnow().strftime(\"%Y-%m-%dT%H:%M:%SZ\")\n}\n\nPath(\"\
        signals\").mkdir(exist_ok=True)\nPath(\"signals/hedge_monitor.json\").write_text(json.dumps(signal,\
        \ indent=2))\nprint(\"wrote signals/hedge_monitor.json\")\nPY\n"
    - uses: actions/upload-artifact@v4
      with:
        name: hedge-monitor
        path: signals/hedge_monitor.json
        retention-days: 3
    needs: precheck
    if: ${{ needs.precheck.outputs.ok == 'true' && github.ref == 'refs/heads/main'
      }}
